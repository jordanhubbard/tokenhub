#!/bin/bash
# Local TokenHub bootstrap — copy to bootstrap.local and fill in your values.
# bootstrap.local is gitignored and will not be committed.
#
# Runs automatically after: make run
# Or manually via: make bootstrap, ./bootstrap.local
#
# This script configures a running TokenHub instance via tokenhubctl.
# It registers providers, models, and API keys — anything that requires
# secrets you don't want in env vars or git.
#
# Prerequisites:
#   - tokenhubctl on $PATH or at ./bin/tokenhubctl
#     Build it: make build (or: go build -o bin/tokenhubctl ./cmd/tokenhubctl)

set -euo pipefail

export TOKENHUB_URL="${TOKENHUB_URL:-http://localhost:8080}"
export TOKENHUB_ADMIN_TOKEN="${TOKENHUB_ADMIN_TOKEN:-}"

TOKENHUBCTL="${TOKENHUBCTL:-tokenhubctl}"
if ! command -v "$TOKENHUBCTL" >/dev/null 2>&1; then
    if [ -x "./bin/tokenhubctl" ]; then
        TOKENHUBCTL="./bin/tokenhubctl"
    else
        echo "ERROR: tokenhubctl not found. Build it: make build"
        exit 1
    fi
fi

# ────────────────────────────────────────────────
# Wait for TokenHub to be healthy
# ────────────────────────────────────────────────

echo "Checking TokenHub..."
$TOKENHUBCTL status

# ────────────────────────────────────────────────
# Phase 1 (optional): Unlock the vault
# ────────────────────────────────────────────────

# $TOKENHUBCTL vault unlock "your-vault-password-here"

# ────────────────────────────────────────────────
# Phase 2: Register providers with API keys
# ────────────────────────────────────────────────

echo
echo "=== Registering providers ==="

# OpenAI-compatible provider:
# $TOKENHUBCTL provider add '{"id":"openai","type":"openai","base_url":"https://api.openai.com","api_key":"'"$OPENAI_API_KEY"'"}'

# Anthropic provider:
# $TOKENHUBCTL provider add '{"id":"anthropic","type":"anthropic","base_url":"https://api.anthropic.com","api_key":"'"$ANTHROPIC_API_KEY"'"}'

# ────────────────────────────────────────────────
# Phase 3: Register models
# ────────────────────────────────────────────────

echo
echo "=== Registering models ==="

# $TOKENHUBCTL model add '{"id":"gpt-4o","provider_id":"openai","weight":8,"max_context_tokens":128000,"input_per_1k":0.0025,"output_per_1k":0.01,"enabled":true}'

# $TOKENHUBCTL model add '{"id":"claude-opus-4","provider_id":"anthropic","weight":10,"max_context_tokens":200000,"input_per_1k":0.015,"output_per_1k":0.075,"enabled":true}'

# Local vLLM model (register the vLLM provider first via admin API):
# $TOKENHUBCTL model add '{"id":"Qwen/Qwen2.5-Coder-32B-Instruct","provider_id":"vllm","weight":7,"max_context_tokens":32000,"input_per_1k":0.0,"output_per_1k":0.0,"enabled":true}'

# ────────────────────────────────────────────────
# Phase 4 (optional): Create an API key
# ────────────────────────────────────────────────

# $TOKENHUBCTL apikey create '{"name":"my-app","scopes":"[\"chat\",\"plan\"]","monthly_budget_usd":50.0}'

# ────────────────────────────────────────────────
# Done
# ────────────────────────────────────────────────

echo
echo "=== Bootstrap complete ==="
$TOKENHUBCTL model list
echo
echo "Admin UI: $TOKENHUB_URL/admin"
