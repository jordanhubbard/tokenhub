<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TokenHub Admin</title>
  <script src="/_assets/cytoscape.min.js"></script>
  <script src="/_assets/d3.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f1117; color: #e0e0e0; }
    .header { background: #1a1d29; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #2a2d3a; }
    .header h1 { font-size: 18px; color: #fff; }
    .header .status { font-size: 12px; color: #4caf50; }
    .header .status.disconnected { color: #f44336; }
    .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; }
    .panel { background: #1a1d29; border: 1px solid #2a2d3a; border-radius: 8px; padding: 16px; overflow: hidden; }
    .panel h2 { font-size: 14px; color: #8a8d9a; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    .panel.full-width { grid-column: 1 / 3; }
    .panel.graph { min-height: 420px; }
    #cy { width: 100%; height: 380px; }
    #trend-chart { width: 100%; height: 220px; }
    .stat-row { display: flex; gap: 16px; margin-bottom: 8px; }
    .stat-box { flex: 1; background: #12141d; border-radius: 6px; padding: 12px; text-align: center; }
    .stat-box .value { font-size: 24px; font-weight: 600; color: #fff; }
    .stat-box .label { font-size: 11px; color: #8a8d9a; margin-top: 4px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; }
    .badge.healthy { background: #1b3a1b; color: #4caf50; }
    .badge.degraded { background: #3a3a1b; color: #ffc107; }
    .badge.down { background: #3a1b1b; color: #f44336; }
    .leaderboard table, .admin-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .leaderboard th, .admin-table th { text-align: left; color: #8a8d9a; padding: 6px 8px; border-bottom: 1px solid #2a2d3a; }
    .leaderboard td, .admin-table td { padding: 6px 8px; border-bottom: 1px solid #1f2233; }
    .weight-slider { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .weight-slider label { min-width: 120px; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .weight-slider input[type=range] { flex: 1; accent-color: #4caf50; }
    .weight-slider .weight-val { min-width: 30px; font-size: 12px; text-align: right; }
    .tabs { display: flex; gap: 8px; margin-bottom: 8px; }
    .tabs button { background: #12141d; border: 1px solid #2a2d3a; color: #8a8d9a; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .tabs button.active { background: #2a2d3a; color: #fff; }
    .vault-status { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .vault-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    .vault-indicator.locked { background: #f44336; }
    .vault-indicator.unlocked { background: #4caf50; }
    .vault-label { font-size: 14px; font-weight: 500; }
    .vault-controls { display: flex; gap: 8px; align-items: center; }
    .vault-controls input[type=password] { background: #12141d; border: 1px solid #2a2d3a; color: #e0e0e0; padding: 6px 10px; border-radius: 4px; font-size: 13px; width: 220px; }
    .btn { background: #2a2d3a; border: 1px solid #3a3d4a; color: #e0e0e0; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .btn:hover { background: #3a3d4a; }
    .btn.primary { background: #1b5e20; border-color: #2e7d32; color: #fff; }
    .btn.primary:hover { background: #2e7d32; }
    .btn.danger { background: #b71c1c; border-color: #c62828; color: #fff; }
    .btn.danger:hover { background: #c62828; }
    .btn.sm { padding: 3px 10px; font-size: 11px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .admin-form { display: flex; flex-wrap: wrap; gap: 8px; align-items: flex-end; margin-top: 12px; padding-top: 12px; border-top: 1px solid #2a2d3a; }
    .admin-form .field, .routing-form .field, .modal .field { display: flex; flex-direction: column; gap: 3px; }
    .admin-form .field label, .routing-form .field label, .modal .field label { font-size: 11px; color: #8a8d9a; }
    .admin-form .field input, .admin-form .field select, .routing-form .field input, .routing-form .field select { background: #12141d; border: 1px solid #2a2d3a; color: #e0e0e0; padding: 5px 8px; border-radius: 4px; font-size: 12px; }
    .admin-form .field select, .routing-form .field select { min-width: 120px; }
    .admin-form .field input, .routing-form .field input { min-width: 100px; }
    .routing-form { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 10px 18px; border-radius: 6px; font-size: 13px; color: #fff; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
    .toast.success { background: #1b5e20; }
    .toast.error { background: #b71c1c; }
    .toast.visible { opacity: 1; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; }
    .modal-overlay.visible { display: flex; }
    .modal { background: #1a1d29; border: 1px solid #2a2d3a; border-radius: 8px; padding: 24px; min-width: 480px; max-width: 600px; max-height: 80vh; overflow-y: auto; }
    .modal h3 { font-size: 16px; margin-bottom: 16px; color: #fff; }
    .modal .field { margin-bottom: 12px; }
    .modal .field label { display: block; font-size: 11px; color: #8a8d9a; margin-bottom: 4px; }
    .modal .field input, .modal .field select { width: 100%; background: #12141d; border: 1px solid #2a2d3a; color: #e0e0e0; padding: 6px 10px; border-radius: 4px; font-size: 13px; }
    .modal .actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
    .key-display { background: #12141d; border: 1px solid #2a2d3a; border-radius: 4px; padding: 12px; font-family: monospace; font-size: 13px; color: #4caf50; word-break: break-all; margin: 8px 0; }
    .key-warning { color: #ffc107; font-size: 12px; margin-top: 8px; }
    .scope-checks { display: flex; gap: 16px; }
    .scope-checks label { font-size: 13px; color: #e0e0e0; cursor: pointer; }
    .scope-checks input[type=checkbox] { accent-color: #4caf50; }
    .wizard-steps { display: flex; gap: 4px; margin-bottom: 20px; }
    .wizard-step { flex: 1; height: 4px; border-radius: 2px; background: #2a2d3a; }
    .wizard-step.active { background: #4caf50; }
    .wizard-step.done { background: #2e7d32; }
    .wizard-body { min-height: 160px; }
    .discover-list { max-height: 240px; overflow-y: auto; margin: 8px 0; }
    .discover-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-bottom: 1px solid #1f2233; font-size: 13px; }
    .discover-item input[type=checkbox] { accent-color: #4caf50; }
    .discover-item .registered { color: #4caf50; font-size: 11px; }
    .discover-item .model-id { flex: 1; font-family: monospace; }
    .test-result { padding: 8px 12px; border-radius: 4px; font-size: 13px; margin-top: 8px; }
    .test-result.ok { background: #1b3a1b; color: #4caf50; }
    .test-result.fail { background: #3a1b1b; color: #f44336; }
    .live-feed { max-height: 320px; overflow-y: auto; font-size: 12px; font-family: monospace; line-height: 1.6; }
    .live-feed .entry { padding: 3px 0; border-bottom: 1px solid #1a1d29; display: flex; gap: 8px; align-items: baseline; }
    .live-feed .ts { color: #555; min-width: 70px; }
    .live-feed .model { color: #64b5f6; }
    .live-feed .provider { color: #ce93d8; }
    .live-feed .latency { color: #ffc107; min-width: 60px; text-align: right; }
    .live-feed .cost { color: #4caf50; min-width: 70px; text-align: right; }
    .live-feed .tokens { color: #81d4fa; min-width: 60px; text-align: right; font-size: 11px; }
    .live-feed .reason { color: #666; }
    .live-feed .err { color: #f44336; }
    .live-feed .entry.error { background: rgba(244,67,54,0.05); }
    .whatif-result { margin-top: 12px; }
    .whatif-result table { width: 100%; }
    .whatif-result .selected-row { background: rgba(76,175,80,0.1); }
    .whatif-result .selected-row td:first-child::before { content: '\25B6 '; color: #4caf50; }
    .health-row.healthy td { border-left: 3px solid #4caf50; }
    .health-row.degraded td { border-left: 3px solid #ffc107; }
    .health-row.unavailable td { border-left: 3px solid #f44336; }
    .health-avail { font-weight: 500; }
    .health-avail.yes { color: #4caf50; }
    .health-avail.no { color: #f44336; }
    .health-avail.degraded { color: #ffc107; }
    .wf-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .wf-badge.running { background: #1b2a3a; color: #64b5f6; }
    .wf-badge.completed { background: #1b3a1b; color: #4caf50; }
    .wf-badge.failed { background: #3a1b1b; color: #f44336; }
    .wf-badge.timed-out { background: #3a3a1b; color: #ffc107; }
    .wf-badge.canceled { background: #2a2a2a; color: #8a8d9a; }
    .legend { display: flex; gap: 12px; margin-bottom: 8px; font-size: 11px; }
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .audit-action { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
    .audit-action.create-update { background: #1b3a1b; color: #4caf50; }
    .audit-action.delete { background: #3a1b1b; color: #f44336; }
    .audit-action.vault { background: #1b2a3a; color: #64b5f6; }
    .audit-action.other { background: #2a2a2a; color: #8a8d9a; }
    .table-wrap { max-height: 300px; overflow-y: auto; }
    .pagination { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .pagination .page-info { font-size: 12px; color: #8a8d9a; margin-left: auto; }
    .toggle-switch { cursor: pointer; font-size: 18px; }
    @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; } .panel.full-width { grid-column: 1; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>TokenHub</h1>
    <div style="display:flex;align-items:center;gap:16px;">
      <a href="/docs/" target="_blank" style="color:#64b5f6;font-size:13px;text-decoration:none;">Docs</a>
      <span id="sse-status" class="status disconnected">Disconnected</span>
    </div>
  </div>
  <div id="toast" class="toast"></div>

  <!-- ===== EDIT PROVIDER MODAL ===== -->
  <div id="edit-provider-modal" class="modal-overlay">
    <div class="modal">
      <h3 id="edit-provider-title">Edit Provider</h3>
      <input type="hidden" id="edit-prov-id">
      <div class="field"><label>Provider ID</label><input type="text" id="edit-prov-id-display" disabled></div>
      <div class="field"><label>Type</label><select id="edit-prov-type"><option value="openai">OpenAI (or compatible)</option><option value="anthropic">Anthropic</option><option value="vllm">vLLM (local)</option></select></div>
      <div class="field"><label>Base URL</label><input type="text" id="edit-prov-url" placeholder="https://api.openai.com"></div>
      <div class="field"><label>API Key (leave blank to keep existing)</label><input type="password" id="edit-prov-key" placeholder="sk-..."></div>
      <div class="field"><label>Enabled</label><select id="edit-prov-enabled"><option value="true">Yes</option><option value="false">No</option></select></div>
      <div class="actions">
        <button class="btn" onclick="hideModal('edit-provider-modal')">Cancel</button>
        <button class="btn primary" onclick="saveProvider()">Save</button>
      </div>
    </div>
  </div>

  <!-- ===== EDIT MODEL MODAL ===== -->
  <div id="edit-model-modal" class="modal-overlay">
    <div class="modal">
      <h3>Edit Model</h3>
      <input type="hidden" id="edit-mdl-id">
      <div class="field"><label>Model ID</label><input type="text" id="edit-mdl-id-display" disabled></div>
      <div class="field"><label>Provider</label><input type="text" id="edit-mdl-provider" disabled></div>
      <div class="field"><label>Weight (1-10)</label><input type="number" id="edit-mdl-weight" min="0" max="10"></div>
      <div class="field"><label>Max Context Tokens</label><input type="number" id="edit-mdl-ctx" min="0"></div>
      <div class="field"><label>Input $/1K tokens</label><input type="number" id="edit-mdl-in" step="0.0001" min="0"></div>
      <div class="field"><label>Output $/1K tokens</label><input type="number" id="edit-mdl-out" step="0.0001" min="0"></div>
      <div class="field"><label>Enabled</label><select id="edit-mdl-enabled"><option value="true">Yes</option><option value="false">No</option></select></div>
      <div class="actions">
        <button class="btn" onclick="hideModal('edit-model-modal')">Cancel</button>
        <button class="btn primary" onclick="saveModel()">Save</button>
      </div>
    </div>
  </div>

  <!-- ===== WIZARD MODAL ===== -->
  <div id="wizard-modal" class="modal-overlay">
    <div class="modal" style="min-width:520px">
      <h3 id="wizard-title">Add Provider</h3>
      <div class="wizard-steps" id="wizard-steps"></div>
      <div class="wizard-body" id="wizard-body"></div>
      <div class="actions" id="wizard-actions"></div>
    </div>
  </div>

  <!-- ===== CREATE KEY MODAL ===== -->
  <div id="create-key-modal" class="modal-overlay">
    <div class="modal">
      <h3>Create API Key</h3>
      <div class="field"><label>Name</label><input type="text" id="new-key-name" placeholder="my-app-key"></div>
      <div class="field"><label>Scopes</label><div class="scope-checks"><label><input type="checkbox" id="scope-chat" checked> chat</label><label><input type="checkbox" id="scope-plan" checked> plan</label></div></div>
      <div class="field"><label>Rotation (days, 0 = manual)</label><select id="new-key-rotation"><option value="0">Manual only</option><option value="7">7 days</option><option value="30">30 days</option><option value="90">90 days</option></select></div>
      <div class="field"><label>Expires at (optional)</label><input type="date" id="new-key-expiry"></div>
      <div class="field"><label>Monthly Budget USD (0 = unlimited)</label><input type="number" id="new-key-budget" step="0.01" min="0" value="0"></div>
      <div class="actions">
        <button class="btn" onclick="hideModal('create-key-modal')">Cancel</button>
        <button class="btn primary" onclick="createAPIKey()">Create</button>
      </div>
    </div>
  </div>

  <!-- ===== KEY DISPLAY MODAL ===== -->
  <div id="key-display-modal" class="modal-overlay">
    <div class="modal">
      <h3>API Key Created</h3>
      <p style="font-size:13px;color:#8a8d9a;margin-bottom:8px">Copy this key now. It will not be shown again.</p>
      <div class="key-display" id="displayed-key"></div>
      <p class="key-warning">This is the only time this key will be displayed.</p>
      <div class="actions">
        <button class="btn" onclick="navigator.clipboard.writeText(document.getElementById('displayed-key').textContent).then(()=>showToast('Copied','success'))">Copy</button>
        <button class="btn primary" onclick="hideModal('key-display-modal')">Done</button>
      </div>
    </div>
  </div>

  <!-- ===== DASHBOARD ===== -->
  <div class="dashboard">

    <!-- Vault -->
    <div class="panel full-width">
      <h2>Vault Status</h2>
      <div class="vault-status">
        <span id="vault-indicator" class="vault-indicator locked"></span>
        <span id="vault-label" class="vault-label">Locked</span>
      </div>
      <div id="vault-controls" class="vault-controls">
        <input type="password" id="vault-password" placeholder="Admin password">
        <button class="btn primary" onclick="vaultUnlock()">Unlock</button>
      </div>
    </div>

    <!-- Provider Management -->
    <div class="panel full-width">
      <h2>Providers <button class="btn primary sm" style="float:right;margin-top:-4px" onclick="openWizard()">+ Add Provider</button></h2>
      <div id="providers-empty" style="display:none;padding:16px;text-align:center;color:#8a8d9a">
        <p style="font-size:14px;margin-bottom:8px">No providers configured yet.</p>
        <p style="font-size:12px;margin-bottom:12px">Add your first LLM provider to get started. Supports OpenAI, Anthropic, vLLM, and any OpenAI-compatible API.</p>
        <button class="btn primary" onclick="openWizard()">Add Your First Provider</button>
      </div>
      <div class="table-wrap" id="providers-table-wrap">
        <table class="admin-table"><thead><tr><th>ID</th><th>Type</th><th>Base URL</th><th>Cred Store</th><th>Enabled</th><th>Actions</th></tr></thead>
        <tbody id="providers-body"></tbody></table>
      </div>
    </div>

    <!-- Model Management -->
    <div class="panel full-width">
      <h2>Models</h2>
      <div class="table-wrap">
        <table class="admin-table"><thead><tr><th>Model ID</th><th>Provider</th><th>Weight</th><th>Context</th><th>In $/1K</th><th>Out $/1K</th><th>Enabled</th><th>Actions</th></tr></thead>
        <tbody id="models-body"></tbody></table>
      </div>
      <div class="admin-form" id="model-form">
        <div class="field"><label>Model ID</label><input type="text" id="mdl-id" placeholder="gpt-4o"></div>
        <div class="field"><label>Provider</label><select id="mdl-provider"></select></div>
        <div class="field"><label>Weight</label><input type="number" id="mdl-weight" value="5" min="0" max="10" style="width:60px"></div>
        <div class="field"><label>Context</label><input type="number" id="mdl-ctx" value="128000" style="width:90px"></div>
        <div class="field"><label>In $/1K</label><input type="number" id="mdl-in" value="0" step="0.0001" style="width:80px"></div>
        <div class="field"><label>Out $/1K</label><input type="number" id="mdl-out" value="0" step="0.0001" style="width:80px"></div>
        <button class="btn primary" onclick="addModel()">Add Model</button>
      </div>
    </div>

    <!-- Routing Config + Health -->
    <div class="panel">
      <h2>Routing Config</h2>
      <div class="routing-form">
        <div class="field"><label>Default Mode</label><select id="route-mode"><option value="cheap">cheap</option><option value="normal" selected>normal</option><option value="high_confidence">high_confidence</option><option value="planning">planning</option><option value="adversarial">adversarial</option></select></div>
        <div class="field"><label>Max Budget $</label><input type="number" id="route-budget" step="0.01" min="0" value="0.05" style="width:80px"></div>
        <div class="field"><label>Max Latency ms</label><input type="number" id="route-latency" step="1000" min="0" value="20000" style="width:90px"></div>
        <button class="btn primary" onclick="saveRoutingConfig()">Save</button>
      </div>
    </div>

    <div class="panel">
      <h2>Health Status</h2>
      <div class="table-wrap">
        <table class="admin-table"><thead><tr><th>Provider</th><th>Available</th><th>Latency</th><th>Err Rate</th><th>Consec Err</th><th>State</th></tr></thead>
        <tbody id="health-body"></tbody></table>
      </div>
    </div>

    <!-- API Keys -->
    <div class="panel full-width">
      <h2>API Keys <button class="btn primary sm" style="float:right;margin-top:-4px" onclick="showModal('create-key-modal')">+ Create Key</button></h2>
      <div class="table-wrap">
        <table class="admin-table"><thead><tr><th>Name</th><th>Prefix</th><th>Scopes</th><th>Created</th><th>Last Used</th><th>Budget</th><th>Enabled</th><th>Actions</th></tr></thead>
        <tbody id="apikeys-body"></tbody></table>
      </div>
    </div>

    <!-- Topology Graph -->
    <div class="panel graph">
      <h2>Request Flow <span style="font-size:11px;color:#555;text-transform:none;letter-spacing:0">(live)</span></h2>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:#2196f3"></div> Gateway</div>
        <div class="legend-item"><div class="legend-dot" style="background:#ce93d8"></div> Provider</div>
        <div class="legend-item"><div class="legend-dot" style="background:#4caf50"></div> Model</div>
      </div>
      <div id="cy"></div>
    </div>

    <!-- Overview + Trends -->
    <div class="panel">
      <h2>Overview</h2>
      <div class="stat-row">
        <div class="stat-box"><div class="value" id="total-requests">0</div><div class="label">Requests</div></div>
        <div class="stat-box"><div class="value" id="total-tokens">0</div><div class="label">Tokens</div></div>
        <div class="stat-box"><div class="value" id="total-cost">$0.00</div><div class="label">Cost</div></div>
        <div class="stat-box"><div class="value" id="avg-latency">0ms</div><div class="label">Avg Latency</div></div>
        <div class="stat-box"><div class="value" id="error-rate">0%</div><div class="label">Errors</div></div>
      </div>
      <h2 style="margin-top:12px">Trends</h2>
      <div class="tabs" id="trend-tabs">
        <button class="active" onclick="switchTrend('cost',this)">Cost</button>
        <button onclick="switchTrend('tokens',this)">Tokens</button>
        <button onclick="switchTrend('latency',this)">Latency</button>
      </div>
      <div id="trend-chart"></div>
    </div>

    <!-- Live Decision Feed -->
    <div class="panel full-width">
      <h2>Live Routing Decisions <span style="font-size:11px;color:#555;text-transform:none;letter-spacing:0" id="feed-count"></span></h2>
      <div class="live-feed" id="live-feed"></div>
    </div>

    <!-- Model Leaderboard + Weights -->
    <div class="panel leaderboard">
      <h2>Model Leaderboard</h2>
      <div class="table-wrap">
        <table><thead><tr><th>Model</th><th>Provider</th><th>Wt</th><th>Reqs</th><th>Tokens</th><th>Latency</th><th>Cost</th><th>Status</th></tr></thead>
        <tbody id="leaderboard-body"></tbody></table>
      </div>
      <h2 style="margin-top:16px">Weights</h2>
      <div id="weight-sliders"></div>
    </div>

    <!-- What-If Simulator -->
    <div class="panel">
      <h2>What-If Simulator</h2>
      <div class="routing-form">
        <div class="field"><label>Mode</label><select id="sim-mode"><option value="cheap">cheap</option><option value="normal" selected>normal</option><option value="high_confidence">high_confidence</option><option value="planning">planning</option><option value="thompson">thompson</option></select></div>
        <div class="field"><label>Tokens</label><input type="number" id="sim-tokens" value="500" min="1" style="width:80px"></div>
        <div class="field"><label>Budget $</label><input type="number" id="sim-budget" value="0.05" step="0.01" min="0" style="width:80px"></div>
        <div class="field"><label>Min Weight</label><input type="number" id="sim-weight" value="0" min="0" max="10" style="width:60px"></div>
        <button class="btn primary" onclick="runSimulation()">Simulate</button>
      </div>
      <div class="whatif-result" id="whatif-result"></div>
    </div>

    <!-- Workflows -->
    <div class="panel full-width">
      <h2>Workflows</h2>
      <div style="margin-bottom:8px"><select id="wf-status-filter" onchange="fetchWorkflows()" style="background:#12141d;border:1px solid #2a2d3a;color:#e0e0e0;padding:4px 8px;border-radius:4px;font-size:12px"><option value="">All</option><option value="RUNNING">Running</option><option value="COMPLETED">Completed</option><option value="FAILED">Failed</option></select></div>
      <div class="table-wrap">
        <table class="admin-table"><thead><tr><th>Workflow ID</th><th>Type</th><th>Status</th><th>Started</th><th>Duration</th><th>Model</th></tr></thead>
        <tbody id="workflows-body"></tbody></table>
      </div>
    </div>

    <!-- Audit Log -->
    <div class="panel full-width">
      <h2>Audit Log</h2>
      <div class="table-wrap">
        <table class="admin-table"><thead><tr><th>Time</th><th>Action</th><th>Resource</th><th>Request ID</th></tr></thead>
        <tbody id="audit-body"></tbody></table>
      </div>
    </div>

    <!-- Request Log (poll-based, kept for historical browsing) -->
    <div class="panel full-width">
      <h2>Request Log (Historical)</h2>
      <div class="table-wrap">
        <table class="admin-table"><thead><tr><th>Time</th><th>Model</th><th>Provider</th><th>Mode</th><th>Latency</th><th>Tokens</th><th>Cost</th><th>Status</th><th>Request ID</th></tr></thead>
        <tbody id="request-log-body"></tbody></table>
      </div>
      <div class="pagination">
        <button class="btn sm" id="req-log-prev" onclick="requestLogPrev()" disabled>Prev</button>
        <button class="btn sm" id="req-log-next" onclick="requestLogNext()">Next</button>
        <span class="page-info" id="req-log-page-info">Page 1</span>
      </div>
    </div>
  </div>

<script>
// ============================
// Cytoscape.js Enhanced Graph
// ============================
const cy = cytoscape({
  container: document.getElementById('cy'),
  style: [
    { selector: 'node', style: {
      'label': 'data(label)', 'text-valign': 'center', 'color': '#e0e0e0',
      'background-color': 'data(color)', 'width': 'data(size)', 'height': 'data(size)',
      'font-size': '10px', 'text-outline-width': 1, 'text-outline-color': '#0f1117',
      'border-width': 'data(borderWidth)', 'border-color': 'data(borderColor)'
    }},
    { selector: 'edge', style: {
      'width': 'data(width)', 'line-color': 'data(color)', 'target-arrow-color': 'data(color)',
      'target-arrow-shape': 'triangle', 'curve-style': 'bezier', 'opacity': 'data(opacity)',
      'label': 'data(edgeLabel)', 'font-size': '9px', 'color': '#666',
      'text-rotation': 'autorotate', 'text-outline-width': 1, 'text-outline-color': '#0f1117'
    }},
    { selector: '.flash', style: { 'line-color': '#64b5f6', 'target-arrow-color': '#64b5f6', 'opacity': 1, 'width': 4 }}
  ],
  layout: { name: 'cose', animate: false },
  elements: [{ data: { id: 'tokenhub', label: 'TokenHub', color: '#2196f3', size: 55, borderWidth: 0, borderColor: '#2196f3' } }]
});

const knownProviders = new Set();
const knownModels = new Set();
const edgeStats = {};
const providerLatency = {};

function latencyColor(ms) {
  if (ms < 500) return '#4caf50';
  if (ms < 2000) return '#ffc107';
  return '#f44336';
}

function ensureNode(id, label, type) {
  if ((type === 'provider' && knownProviders.has(id)) || (type === 'model' && knownModels.has(id))) return;
  const color = type === 'provider' ? '#ce93d8' : '#4caf50';
  cy.add({ data: { id, label: label.length > 20 ? label.slice(0,18)+'...' : label, color, size: type === 'provider' ? 40 : 30, borderWidth: 0, borderColor: color } });
  if (type === 'provider') {
    cy.add({ data: { id: 'th-'+id, source: 'tokenhub', target: id, width: 2, color: '#3a5a8a', opacity: 0.5, edgeLabel: '' } });
    knownProviders.add(id);
  } else {
    knownModels.add(id);
  }
  cy.layout({ name: 'cose', animate: true, animationDuration: 300, nodeRepulsion: () => 8000 }).run();
}

function animateEdge(providerId, modelId, latencyMs, costUSD) {
  const edgeId = `${providerId}-${modelId}`;
  ensureNode(providerId, providerId, 'provider');
  ensureNode(modelId, modelId, 'model');

  if (!cy.getElementById(edgeId).length) {
    cy.add({ data: { id: edgeId, source: providerId, target: modelId, width: 2, color: '#3a5a8a', opacity: 0.6, edgeLabel: '' } });
    cy.layout({ name: 'cose', animate: true, animationDuration: 300, nodeRepulsion: () => 8000 }).run();
  }

  const s = edgeStats[edgeId] || { count: 0, totalLatency: 0 };
  s.count++;
  s.totalLatency += latencyMs || 0;
  edgeStats[edgeId] = s;

  const avgLat = s.totalLatency / s.count;
  const edge = cy.getElementById(edgeId);
  edge.data('width', Math.min(2 + Math.log2(s.count + 1) * 2, 12));
  edge.data('color', latencyColor(avgLat));
  edge.data('opacity', 0.9);
  edge.data('edgeLabel', Math.round(avgLat) + 'ms');
  edge.addClass('flash');
  setTimeout(() => edge.removeClass('flash'), 400);

  // Size provider node by throughput.
  providerLatency[providerId] = (providerLatency[providerId] || 0) + 1;
  const provNode = cy.getElementById(providerId);
  if (provNode.length) {
    provNode.data('size', Math.min(40 + Math.log2(providerLatency[providerId] + 1) * 5, 70));
    provNode.data('borderWidth', 2);
    provNode.data('borderColor', latencyColor(avgLat));
  }
}

// ============================
// D3.js Multi-Series Chart
// ============================
const trendData = {};
const chartMargin = { top: 10, right: 80, bottom: 20, left: 50 };
let chartSvg, chartG, xScale, yScale, chartW, chartH;
let currentTrendMetric = 'cost';
const seriesColors = ['#4caf50','#64b5f6','#ce93d8','#ffc107','#ff7043','#26a69a','#ab47bc','#ef5350'];

function initChart() {
  const container = document.getElementById('trend-chart');
  const w = container.clientWidth || 400;
  const h = 220;
  chartW = w - chartMargin.left - chartMargin.right;
  chartH = h - chartMargin.top - chartMargin.bottom;
  chartSvg = d3.select('#trend-chart').append('svg').attr('width', w).attr('height', h);
  chartG = chartSvg.append('g').attr('transform', `translate(${chartMargin.left},${chartMargin.top})`);
  xScale = d3.scaleTime().range([0, chartW]);
  yScale = d3.scaleLinear().range([chartH, 0]);
  chartG.append('g').attr('class', 'x-axis').attr('transform', `translate(0,${chartH})`);
  chartG.append('g').attr('class', 'y-axis');
  chartG.append('g').attr('class', 'lines');
  chartG.append('g').attr('class', 'chart-legend');
}

function updateChart() {
  if (!chartSvg) return;
  const allPoints = [];
  const seriesKeys = Object.keys(trendData);
  seriesKeys.forEach(k => trendData[k].forEach(p => allPoints.push(p)));
  if (allPoints.length < 2) return;

  xScale.domain(d3.extent(allPoints, d => d.time));
  const maxVal = d3.max(allPoints, d => d.value) * 1.1 || 0.01;
  yScale.domain([0, maxVal]);

  const line = d3.line().x(d => xScale(d.time)).y(d => yScale(d.value)).curve(d3.curveMonotoneX);
  const linesG = chartG.select('.lines');

  seriesKeys.forEach((key, i) => {
    const color = seriesColors[i % seriesColors.length];
    let path = linesG.select('.line-' + CSS.escape(key));
    if (path.empty()) {
      path = linesG.append('path').attr('class', 'line-' + CSS.escape(key))
        .attr('fill', 'none').attr('stroke', color).attr('stroke-width', 1.5).attr('opacity', 0.8);
    }
    path.datum(trendData[key]).attr('d', line);
  });

  const fmt = currentTrendMetric === 'cost' ? d => `$${d.toFixed(3)}` : d => `${d.toFixed(0)}ms`;
  chartG.select('.x-axis').call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.timeFormat('%H:%M')).tickSize(3));
  chartG.select('.y-axis').call(d3.axisLeft(yScale).ticks(4).tickFormat(fmt).tickSize(3));
  chartG.selectAll('.tick text').attr('fill', '#666').attr('font-size', '10px');
  chartG.selectAll('.tick line').attr('stroke', '#333');
  chartG.selectAll('.domain').attr('stroke', '#333');

  // Legend.
  const legendG = chartG.select('.chart-legend');
  legendG.selectAll('*').remove();
  seriesKeys.forEach((key, i) => {
    const color = seriesColors[i % seriesColors.length];
    const y = i * 14;
    legendG.append('rect').attr('x', chartW + 8).attr('y', y).attr('width', 8).attr('height', 8).attr('fill', color).attr('rx', 2);
    legendG.append('text').attr('x', chartW + 20).attr('y', y + 8).attr('fill', '#888').attr('font-size', '9px')
      .text(key.length > 12 ? key.slice(0,10)+'..' : key);
  });
}

function fetchTrend(metric) {
  const start = new Date(Date.now() - 3600000).toISOString();
  fetch(`/admin/v1/tsdb/query?metric=${metric}&start=${start}&step=60000`)
    .then(r => r.json())
    .then(data => {
      // Clear old trend data.
      for (const k of Object.keys(trendData)) delete trendData[k];
      if (!data.series || data.series.length === 0) return;
      data.series.forEach(s => {
        const key = s.model_id || s.provider_id || metric;
        trendData[key] = (s.points || []).map(p => ({ time: new Date(p.t), value: p.v }));
      });
      updateChart();
    }).catch(() => {});
}

function switchTrend(metric, btn) {
  currentTrendMetric = metric;
  document.querySelectorAll('#trend-tabs button').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  fetchTrend(metric);
}

// ============================
// SSE + Live Decision Feed
// ============================
let cumulativeCost = 0, totalRequests = 0, totalErrors = 0, totalLatency = 0, totalTokens = 0;
let feedEntries = 0;
const perModelCost = {};

function connectSSE() {
  const status = document.getElementById('sse-status');
  const es = new EventSource('/admin/v1/events');
  es.addEventListener('connected', () => { status.textContent = 'Connected'; status.className = 'status'; });
  es.addEventListener('route_success', (e) => {
    const d = JSON.parse(e.data);
    totalRequests++; totalLatency += d.latency_ms || 0; cumulativeCost += d.cost_usd || 0;
    totalTokens += d.total_tokens || 0;
    perModelCost[d.model_id] = (perModelCost[d.model_id] || 0) + (d.cost_usd || 0);
    animateEdge(d.provider_id, d.model_id, d.latency_ms, d.cost_usd);
    appendFeedEntry(d, false);
    refreshStats();

    // Push into per-model trend data for live chart.
    const key = d.model_id || 'unknown';
    if (!trendData[key]) trendData[key] = [];
    const val = currentTrendMetric === 'cost' ? (d.cost_usd || 0) : (d.latency_ms || 0);
    trendData[key].push({ time: new Date(d.timestamp || Date.now()), value: val });
    if (trendData[key].length > 200) trendData[key].shift();
    updateChart();
  });
  es.addEventListener('route_error', (e) => {
    const d = JSON.parse(e.data);
    totalRequests++; totalErrors++; totalLatency += d.latency_ms || 0;
    appendFeedEntry(d, true);
    refreshStats();
  });
  es.addEventListener('health_change', (e) => { fetchHealthStatus(); });
  es.onerror = () => { status.textContent = 'Disconnected'; status.className = 'status disconnected'; };
}

function appendFeedEntry(d, isErr) {
  const feed = document.getElementById('live-feed');
  const ts = new Date(d.timestamp || Date.now()).toLocaleTimeString();
  const lat = d.latency_ms ? Math.round(d.latency_ms) + 'ms' : '-';
  const cost = d.cost_usd ? '$' + d.cost_usd.toFixed(4) : '-';
  const tok = d.total_tokens ? d.total_tokens.toLocaleString() + 'tok' : '';
  const cls = isErr ? 'entry error' : 'entry';
  const detail = isErr
    ? `<span class="err">${d.error_class || 'error'}: ${(d.error_msg||'').slice(0,60)}</span>`
    : `<span class="reason">${d.reason || ''}</span>`;
  const html = `<div class="${cls}"><span class="ts">${ts}</span><span class="model">${d.model_id||'-'}</span><span class="provider">${d.provider_id||'-'}</span><span class="latency">${lat}</span><span class="cost">${cost}</span>${tok ? `<span class="tokens">${tok}</span>` : ''}${detail}</div>`;
  feed.insertAdjacentHTML('afterbegin', html);
  feedEntries++;
  if (feedEntries > 200) feed.lastElementChild?.remove();
  document.getElementById('feed-count').textContent = `(${feedEntries})`;
}

function refreshStats() {
  document.getElementById('total-requests').textContent = totalRequests;
  document.getElementById('total-tokens').textContent = totalTokens.toLocaleString();
  document.getElementById('total-cost').textContent = `$${cumulativeCost.toFixed(4)}`;
  document.getElementById('avg-latency').textContent = totalRequests > 0 ? `${Math.round(totalLatency / totalRequests)}ms` : '0ms';
  document.getElementById('error-rate').textContent = totalRequests > 0 ? `${(totalErrors / totalRequests * 100).toFixed(1)}%` : '0%';
}

function seedStatsFromServer() {
  fetch('/admin/v1/stats').then(r => r.json()).then(data => {
    const globals = data.global || [];
    const g24h = globals.find(g => g.window === '24h') || globals.find(g => g.window === '1h') || globals[0];
    if (g24h) {
      totalRequests = g24h.request_count || 0;
      totalErrors = g24h.error_count || 0;
      totalLatency = (g24h.avg_latency_ms || 0) * (g24h.request_count || 1);
      cumulativeCost = g24h.total_cost_usd || 0;
      totalTokens = g24h.total_tokens || 0;
      refreshStats();
    }
  }).catch(() => {});
}

// ============================
// Setup Wizard
// ============================
let wizardState = { step: 0, type: 'openai', id: '', url: '', key: '', discovered: [] };
const wizardStepNames = ['Type', 'Endpoint', 'Credentials', 'Test', 'Discover'];

function openWizard() {
  wizardState = { step: 0, type: 'openai', id: '', url: '', key: '', discovered: [] };
  renderWizard();
  showModal('wizard-modal');
}

function renderWizard() {
  const steps = document.getElementById('wizard-steps');
  steps.innerHTML = wizardStepNames.map((name, i) =>
    `<div class="wizard-step ${i < wizardState.step ? 'done' : ''} ${i === wizardState.step ? 'active' : ''}" title="${name}"></div>`
  ).join('');

  const body = document.getElementById('wizard-body');
  const actions = document.getElementById('wizard-actions');
  const s = wizardState;

  switch (s.step) {
    case 0: // Type
      body.innerHTML = `<div class="field"><label>Provider Type</label><select id="wiz-type" style="width:100%" onchange="wizardState.type=this.value"><option value="openai" ${s.type==='openai'?'selected':''}>OpenAI (or compatible)</option><option value="anthropic" ${s.type==='anthropic'?'selected':''}>Anthropic</option><option value="vllm" ${s.type==='vllm'?'selected':''}>vLLM (local)</option></select></div><div class="field"><label>Provider ID (unique name)</label><input id="wiz-id" value="${s.id}" placeholder="e.g. my-openai" style="width:100%" oninput="wizardState.id=this.value"></div>`;
      actions.innerHTML = `<button class="btn" onclick="hideModal('wizard-modal')">Cancel</button><button class="btn primary" onclick="wizardNext()">Next</button>`;
      break;
    case 1: // Endpoint
      const defaults = { openai: 'https://api.openai.com', anthropic: 'https://api.anthropic.com', vllm: 'http://localhost:8000' };
      if (!s.url) s.url = defaults[s.type] || '';
      body.innerHTML = `<div class="field"><label>Base URL</label><input id="wiz-url" value="${s.url}" placeholder="${defaults[s.type]}" style="width:100%" oninput="wizardState.url=this.value"></div><p style="font-size:12px;color:#666;margin-top:8px">For local vLLM/Ollama, use your machine's LAN address (e.g. http://192.168.1.50:8000)</p>`;
      actions.innerHTML = `<button class="btn" onclick="wizardBack()">Back</button><button class="btn primary" onclick="wizardNext()">Next</button>`;
      break;
    case 2: // Credentials
      body.innerHTML = `<div class="field"><label>API Key ${s.type==='vllm' ? '(optional for local)' : ''}</label><input type="password" id="wiz-key" value="${s.key}" placeholder="${s.type==='vllm'?'Leave blank for no auth':'sk-...'}" style="width:100%" oninput="wizardState.key=this.value"></div><p style="font-size:12px;color:#666;margin-top:8px">${s.type==='vllm' ? 'Most local vLLM instances need no key.' : 'The key will be stored in the encrypted vault.'}</p>`;
      actions.innerHTML = `<button class="btn" onclick="wizardBack()">Back</button><button class="btn primary" onclick="wizardNext()">Next</button>`;
      break;
    case 3: // Test connection
      body.innerHTML = `<p style="margin-bottom:12px">Testing connection to <strong>${s.url}</strong>...</p><div id="wiz-test-result"></div>`;
      actions.innerHTML = `<button class="btn" onclick="wizardBack()">Back</button><button class="btn primary" id="wiz-test-next" disabled onclick="wizardNext()">Next</button>`;
      wizardTestConnection();
      break;
    case 4: // Discover models
      body.innerHTML = `<p style="margin-bottom:8px">Select models to register from <strong>${s.id}</strong>:</p><div class="discover-list" id="wiz-discover-list"><div style="color:#666;padding:12px">Loading...</div></div>`;
      actions.innerHTML = `<button class="btn" onclick="wizardBack()">Back</button><button class="btn primary" onclick="wizardFinish()">Register Selected</button>`;
      wizardDiscoverModels();
      break;
  }
}

function wizardNext() {
  if (wizardState.step === 0 && !wizardState.id.trim()) { showToast('Provider ID is required', 'error'); return; }
  if (wizardState.step === 1 && !wizardState.url.trim()) { showToast('Base URL is required', 'error'); return; }
  wizardState.step++;
  renderWizard();
}

function wizardBack() {
  if (wizardState.step > 0) { wizardState.step--; renderWizard(); }
}

function wizardTestConnection() {
  const el = document.getElementById('wiz-test-result');
  // First register the provider (so discover can use it).
  const body = { id: wizardState.id, type: wizardState.type, base_url: wizardState.url, enabled: true };
  if (wizardState.key) body.api_key = wizardState.key;
  fetch('/admin/v1/providers', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) })
    .then(r => { if (!r.ok) throw new Error('Failed to register'); return r.json(); })
    .then(() => {
      // Test by hitting healthz on the provider (or /v1/models).
      return fetch(`/admin/v1/providers/${encodeURIComponent(wizardState.id)}/discover`);
    })
    .then(r => r.json())
    .then(data => {
      if (data.error) throw new Error(data.error);
      el.innerHTML = `<div class="test-result ok">Connected! Found ${data.total || 0} models.</div>`;
      document.getElementById('wiz-test-next').disabled = false;
    })
    .catch(err => {
      el.innerHTML = `<div class="test-result fail">Connection failed: ${err.message}</div><p style="font-size:12px;color:#666;margin-top:8px">The provider was registered but could not be reached. You can still proceed and add models manually.</p>`;
      document.getElementById('wiz-test-next').disabled = false;
    });
}

function wizardDiscoverModels() {
  fetch(`/admin/v1/providers/${encodeURIComponent(wizardState.id)}/discover`)
    .then(r => r.json())
    .then(data => {
      const list = document.getElementById('wiz-discover-list');
      const models = data.models || [];
      if (models.length === 0) {
        list.innerHTML = '<div style="color:#666;padding:12px">No models discovered. You can add models manually after closing this wizard.</div>';
        return;
      }
      wizardState.discovered = models;
      list.innerHTML = models.map((m, i) => `<div class="discover-item"><input type="checkbox" id="wiz-m-${i}" ${m.registered ? 'checked disabled' : ''}><span class="model-id">${m.id}</span>${m.registered ? '<span class="registered">registered</span>' : ''}${m.owned_by ? '<span style="color:#666;font-size:11px">'+m.owned_by+'</span>' : ''}</div>`).join('');
    })
    .catch(() => {
      document.getElementById('wiz-discover-list').innerHTML = '<div style="color:#666;padding:12px">Could not discover models. Add them manually from the Models panel.</div>';
    });
}

function wizardFinish() {
  const models = wizardState.discovered || [];
  let registered = 0;
  const promises = models.map((m, i) => {
    const cb = document.getElementById('wiz-m-' + i);
    if (!cb || !cb.checked || m.registered) return Promise.resolve();
    registered++;
    return fetch('/admin/v1/models', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id: m.id, provider_id: wizardState.id, weight: 5, max_context_tokens: 0, input_per_1k: 0, output_per_1k: 0, enabled: true })
    });
  });
  Promise.all(promises).then(() => {
    showToast(`Provider added, ${registered} model(s) registered`, 'success');
    hideModal('wizard-modal');
    fetchProviders(); fetchModels(); fetchHealthStatus();
  }).catch(() => showToast('Error registering models', 'error'));
}

// ============================
// What-If Simulator
// ============================
function runSimulation() {
  const body = {
    mode: document.getElementById('sim-mode').value,
    token_count: parseInt(document.getElementById('sim-tokens').value) || 500,
    max_budget_usd: parseFloat(document.getElementById('sim-budget').value) || 0,
    min_weight: parseInt(document.getElementById('sim-weight').value) || 0
  };
  fetch('/admin/v1/routing/simulate', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) })
    .then(r => r.json())
    .then(data => {
      const el = document.getElementById('whatif-result');
      if (data.error) { el.innerHTML = `<div style="color:#f44336;padding:8px">${data.error}</div>`; return; }
      const models = data.eligible || [];
      if (models.length === 0) { el.innerHTML = '<div style="color:#666;padding:8px">No eligible models for these constraints.</div>'; return; }
      el.innerHTML = `<p style="font-size:12px;color:#8a8d9a;margin-bottom:4px">Winner: <strong style="color:#4caf50">${data.decision?.model_id}</strong> (${data.decision?.reason})</p>` +
        '<table class="admin-table"><thead><tr><th>Rank</th><th>Model</th><th>Provider</th><th>Weight</th><th>Context</th><th>Cost est.</th></tr></thead><tbody>' +
        models.map((m, i) => {
          const estCost = ((body.token_count / 1000) * m.input_per_1k + (512/1000) * m.output_per_1k).toFixed(5);
          return `<tr class="${m.selected ? 'selected-row' : ''}"><td>${i+1}</td><td>${m.id}</td><td>${m.provider_id}</td><td>${m.weight}</td><td>${m.max_context_tokens||'-'}</td><td>$${estCost}</td></tr>`;
        }).join('') + '</tbody></table>';
    })
    .catch(() => showToast('Simulation failed', 'error'));
}

// ============================
// Provider + Model Management
// ============================
let adapterInfoMap = {};
function fetchProviders() {
  Promise.all([
    fetch('/admin/v1/providers').then(r => r.json()).catch(() => ({ items: [] })),
    fetch('/admin/v1/engine/models').then(r => r.json()).catch(() => ({ adapters: [], models: [], adapter_info: [] }))
  ]).then(([storeData, engineData]) => {
    const storeProviders = Array.isArray(storeData.items) ? storeData.items : [];
    const storeMap = {};
    storeProviders.forEach(p => { storeMap[p.id] = p; });
    const engineAdapters = engineData.adapters || [];
    const engineModels = engineData.models || [];
    const adapterInfo = engineData.adapter_info || [];

    // Build adapter info lookup (id -> health_endpoint -> derive base URL).
    adapterInfoMap = {};
    adapterInfo.forEach(a => {
      let base = a.health_endpoint || '';
      base = base.replace(/\/v1\/(models|messages)$/, '').replace(/\/health$/, '').replace(/\/v1$/, '');
      adapterInfoMap[a.id] = base;
    });

    // Derive all unique provider IDs from engine models + adapters.
    const allProviderIds = new Set([...Object.keys(storeMap), ...engineAdapters]);
    engineModels.forEach(m => allProviderIds.add(m.provider_id));

    const allProviders = [...allProviderIds].map(id => {
      const sp = storeMap[id];
      const models = engineModels.filter(m => m.provider_id === id);
      const baseUrl = (sp && sp.base_url) || adapterInfoMap[id] || '';
      const isRuntime = !sp;
      return {
        id,
        type: sp ? sp.type : (engineAdapters.includes(id) ? 'openai' : 'env'),
        base_url: baseUrl,
        cred_store: sp ? (sp.cred_store || 'none') : 'env',
        enabled: sp ? sp.enabled : true,
        _runtime: isRuntime,
        _modelCount: models.length
      };
    });

    const tbody = document.getElementById('providers-body');
    const emptyEl = document.getElementById('providers-empty');
    const tableEl = document.getElementById('providers-table-wrap');
    if (allProviders.length === 0) {
      emptyEl.style.display = 'block';
      tableEl.style.display = 'none';
    } else {
      emptyEl.style.display = 'none';
      tableEl.style.display = 'block';
      tbody.innerHTML = allProviders.map(p => {
        const src = p._runtime ? '<span style="color:#64b5f6;font-size:11px">runtime</span>' : p.cred_store;
        const urlDisplay = p.base_url ? p.base_url : '<span style="color:#666">-</span>';
        return `<tr>
          <td>${p.id}</td><td>${p.type}</td><td style="font-family:monospace;font-size:12px;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.base_url}">${urlDisplay}</td><td>${src}</td>
          <td>${p.enabled ? '<span style="color:#4caf50">yes</span>' : '<span style="color:#f44336">no</span>'}</td>
          <td><button class="btn sm" onclick="editProvider('${p.id}','${p.type}','${encodeURIComponent(p.base_url)}',${p.enabled})">Edit</button> <button class="btn sm" onclick="discoverModels('${p.id}')">Discover</button> <button class="btn danger sm" onclick="deleteProvider('${p.id}')">Delete</button></td>
        </tr>`;
      }).join('');
    }
    // Update model form provider dropdown.
    const sel = document.getElementById('mdl-provider');
    const cur = sel.value;
    sel.innerHTML = allProviders.map(p => `<option value="${p.id}" ${p.id===cur?'selected':''}>${p.id}</option>`).join('');

    // Populate topology graph.
    allProviders.forEach(p => ensureNode(p.id, p.id, 'provider'));
    engineModels.forEach(m => {
      ensureNode(m.provider_id, m.provider_id, 'provider');
      ensureNode(m.id, m.id, 'model');
      const edgeId = `${m.provider_id}-${m.id}`;
      if (!cy.getElementById(edgeId).length) {
        cy.add({ data: { id: edgeId, source: m.provider_id, target: m.id, width: 1.5, color: '#3a5a8a', opacity: 0.4, edgeLabel: '' } });
      }
    });
    cy.layout({ name: 'cose', animate: true, animationDuration: 400, nodeRepulsion: () => 8000 }).run();
  });
}

function editProvider(id, type, encodedUrl, enabled) {
  document.getElementById('edit-prov-id').value = id;
  document.getElementById('edit-prov-id-display').value = id;
  document.getElementById('edit-prov-type').value = type || 'openai';
  document.getElementById('edit-prov-url').value = decodeURIComponent(encodedUrl || '');
  document.getElementById('edit-prov-key').value = '';
  document.getElementById('edit-prov-enabled').value = String(!!enabled);
  document.getElementById('edit-provider-title').textContent = 'Edit Provider: ' + id;
  showModal('edit-provider-modal');
}

function saveProvider() {
  const id = document.getElementById('edit-prov-id').value;
  const body = {
    type: document.getElementById('edit-prov-type').value,
    base_url: document.getElementById('edit-prov-url').value.trim(),
    enabled: document.getElementById('edit-prov-enabled').value === 'true'
  };
  const key = document.getElementById('edit-prov-key').value.trim();
  if (key) body.api_key = key;
  fetch('/admin/v1/providers/' + encodeURIComponent(id), { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) })
    .then(r => { if (!r.ok) throw 0; return r.json(); })
    .then(() => { showToast('Provider updated', 'success'); hideModal('edit-provider-modal'); fetchProviders(); })
    .catch(() => showToast('Failed to update provider', 'error'));
}

function deleteProvider(id) {
  if (!confirm('Delete provider "' + id + '"?')) return;
  fetch('/admin/v1/providers/' + encodeURIComponent(id), { method: 'DELETE' })
    .then(r => { if (!r.ok) throw 0; return r.json(); })
    .then(() => { showToast('Deleted', 'success'); fetchProviders(); })
    .catch(() => showToast('Failed', 'error'));
}

function discoverModels(provId) {
  wizardState = { step: 4, type: '', id: provId, url: '', key: '', discovered: [] };
  document.getElementById('wizard-title').textContent = 'Discover Models: ' + provId;
  renderWizard();
  showModal('wizard-modal');
}

function fetchModels() {
  // Merge store models with engine models so runtime-registered models appear.
  Promise.all([
    fetch('/admin/v1/models').then(r => r.json()).catch(() => ({ items: [] })),
    fetch('/admin/v1/engine/models').then(r => r.json()).catch(() => ({ models: [] }))
  ]).then(([storeData, engineData]) => {
    const storeModels = Array.isArray(storeData.items) ? storeData.items : [];
    const storeIds = new Set(storeModels.map(m => m.id));
    const engineModels = engineData.models || [];

    // Add engine-only models not in store.
    const runtimeModels = engineModels.filter(m => !storeIds.has(m.id));
    const allModels = [...storeModels, ...runtimeModels];

    const tbody = document.getElementById('models-body');
    if (allModels.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="color:#8a8d9a;text-align:center">No models</td></tr>';
    } else {
      tbody.innerHTML = allModels.map(m => `<tr>
        <td style="font-family:monospace;font-size:12px">${m.id}</td><td>${m.provider_id}</td><td>${m.weight}</td><td>${m.max_context_tokens||'-'}</td>
        <td>${m.input_per_1k}</td><td>${m.output_per_1k}</td>
        <td><span class="toggle-switch" onclick="toggleModel('${m.id}',${!m.enabled})">${m.enabled?'&#9989;':'&#10060;'}</span></td>
        <td><button class="btn sm" onclick="editModel('${m.id}','${m.provider_id}',${m.weight},${m.max_context_tokens||0},${m.input_per_1k},${m.output_per_1k},${m.enabled})">Edit</button> <button class="btn danger sm" onclick="deleteModel('${m.id}')">Delete</button></td>
      </tr>`).join('');
    }
  });
}

function addModel() {
  const id = document.getElementById('mdl-id').value.trim();
  if (!id) { showToast('Model ID required', 'error'); return; }
  const body = {
    id, provider_id: document.getElementById('mdl-provider').value,
    weight: parseInt(document.getElementById('mdl-weight').value) || 5,
    max_context_tokens: parseInt(document.getElementById('mdl-ctx').value) || 0,
    input_per_1k: parseFloat(document.getElementById('mdl-in').value) || 0,
    output_per_1k: parseFloat(document.getElementById('mdl-out').value) || 0,
    enabled: true
  };
  fetch('/admin/v1/models', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) })
    .then(r => { if (!r.ok) throw 0; return r.json(); })
    .then(() => { showToast('Model added', 'success'); document.getElementById('mdl-id').value = ''; fetchModels(); })
    .catch(() => showToast('Failed', 'error'));
}

function deleteModel(id) {
  if (!confirm('Delete model "' + id + '"?')) return;
  fetch('/admin/v1/models/' + id, { method: 'DELETE' })
    .then(r => { if (!r.ok) throw 0; return r.json(); })
    .then(() => { showToast('Deleted', 'success'); fetchModels(); })
    .catch(() => showToast('Failed', 'error'));
}

function toggleModel(id, enabled) {
  fetch('/admin/v1/models/' + id, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ enabled }) })
    .then(r => { if (!r.ok) throw 0; return r.json(); })
    .then(() => fetchModels())
    .catch(() => showToast('Failed', 'error'));
}

function editModel(id, providerId, weight, ctx, inCost, outCost, enabled) {
  document.getElementById('edit-mdl-id').value = id;
  document.getElementById('edit-mdl-id-display').value = id;
  document.getElementById('edit-mdl-provider').value = providerId;
  document.getElementById('edit-mdl-weight').value = weight;
  document.getElementById('edit-mdl-ctx').value = ctx || 0;
  document.getElementById('edit-mdl-in').value = inCost;
  document.getElementById('edit-mdl-out').value = outCost;
  document.getElementById('edit-mdl-enabled').value = String(!!enabled);
  showModal('edit-model-modal');
}

function saveModel() {
  const id = document.getElementById('edit-mdl-id').value;
  const body = {
    weight: parseInt(document.getElementById('edit-mdl-weight').value) || 5,
    max_context_tokens: parseInt(document.getElementById('edit-mdl-ctx').value) || 0,
    input_per_1k: parseFloat(document.getElementById('edit-mdl-in').value) || 0,
    output_per_1k: parseFloat(document.getElementById('edit-mdl-out').value) || 0,
    enabled: document.getElementById('edit-mdl-enabled').value === 'true'
  };
  fetch('/admin/v1/models/' + id, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) })
    .then(r => { if (!r.ok) throw 0; return r.json(); })
    .then(() => { showToast('Model updated', 'success'); hideModal('edit-model-modal'); fetchModels(); })
    .catch(() => showToast('Failed to update model', 'error'));
}

// ============================
// Leaderboard + Weights
// ============================
let modelWeights = {};

function updateLeaderboard() {
  fetch('/admin/v1/models').then(r => r.json()).then(data => {
    const items = data.items || data || [];
    if (Array.isArray(items)) {
      items.forEach(m => { modelWeights[m.id] = m.weight; });
      renderWeightSliders(items);
    }
  }).catch(() => {});
  fetch('/admin/v1/stats').then(r => r.json()).then(data => {
    const tbody = document.getElementById('leaderboard-body');
    const windows = data.by_model || {};
    const models = windows['24h'] || windows['1h'] || windows['5m'] || windows['1m'] || [];
    tbody.innerHTML = models.map(m => `<tr>
      <td>${m.model_id}</td><td>${m.provider_id||'-'}</td><td>${modelWeights[m.model_id]||'-'}</td><td>${m.request_count}</td>
      <td>${(m.total_tokens||0).toLocaleString()}</td>
      <td>${Math.round(m.avg_latency_ms)}ms</td><td>$${(m.total_cost_usd||0).toFixed(4)}</td>
      <td><span class="badge ${m.error_rate>0.5?'down':m.error_rate>0.1?'degraded':'healthy'}">${(m.error_rate*100).toFixed(0)}%</span></td>
    </tr>`).join('');
  }).catch(() => {});
}

function renderWeightSliders(models) {
  document.getElementById('weight-sliders').innerHTML = models.map(m => `<div class="weight-slider"><label title="${m.id}">${m.id}</label><input type="range" min="1" max="10" value="${m.weight}" data-model-id="${m.id}" onchange="updateWeight(this)"><span class="weight-val">${m.weight}</span></div>`).join('');
}

function updateWeight(el) {
  const modelId = el.dataset.modelId;
  el.nextElementSibling.textContent = el.value;
  fetch(`/admin/v1/models/${modelId}`, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ weight: parseInt(el.value) }) }).catch(() => {});
}

// ============================
// Vault, Routing, Health, Audit, Logs, Keys, Workflows
// ============================
let vaultInitialized = false;
function fetchVaultStatus() {
  fetch('/admin/api/info').then(r=>r.json()).then(data => {
    const locked = data.vault_locked;
    vaultInitialized = !!data.vault_initialized;
    document.getElementById('vault-indicator').className = 'vault-indicator ' + (locked ? 'locked' : 'unlocked');
    if (!locked) {
      document.getElementById('vault-label').textContent = 'Unlocked';
      document.getElementById('vault-controls').innerHTML = '<button class="btn danger" onclick="vaultLock()">Lock</button>';
    } else if (!vaultInitialized) {
      document.getElementById('vault-label').textContent = 'First-Time Setup';
      document.getElementById('vault-controls').innerHTML =
        '<div style="max-width:420px">' +
        '<p style="font-size:13px;color:#ffc107;margin-bottom:8px">The vault has not been initialized yet. Choose a master password (8+ characters) to encrypt your provider API keys and secrets.</p>' +
        '<p style="font-size:12px;color:#8a8d9a;margin-bottom:10px">This password will be required each time you restart TokenHub. Store it somewhere safe.</p>' +
        '<div style="display:flex;gap:8px;align-items:center">' +
        '<input type="password" id="vault-password" placeholder="Choose a master password (8+ chars)" style="flex:1;background:#12141d;border:1px solid #2a2d3a;color:#e0e0e0;padding:6px 10px;border-radius:4px;font-size:13px">' +
        ' <button class="btn primary" onclick="vaultUnlock()">Initialize Vault</button>' +
        '</div></div>';
    } else {
      document.getElementById('vault-label').textContent = 'Locked';
      document.getElementById('vault-controls').innerHTML =
        '<input type="password" id="vault-password" placeholder="Enter master password" style="background:#12141d;border:1px solid #2a2d3a;color:#e0e0e0;padding:6px 10px;border-radius:4px;font-size:13px;width:220px">' +
        ' <button class="btn primary" onclick="vaultUnlock()">Unlock</button>';
    }
  }).catch(() => {});
}
function vaultUnlock() {
  const pw = document.getElementById('vault-password');
  if (!pw?.value) return;
  if (pw.value.length < 8) { showToast('Password must be at least 8 characters', 'error'); return; }
  fetch('/admin/v1/vault/unlock', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({admin_password:pw.value}) })
    .then(r => { if (!r.ok) throw 0; showToast(vaultInitialized ? 'Unlocked' : 'Vault initialized and unlocked', 'success'); fetchVaultStatus(); })
    .catch(() => showToast('Failed','error'));
}
function vaultLock() {
  fetch('/admin/v1/vault/lock', { method:'POST', headers:{'Content-Type':'application/json'} })
    .then(() => { showToast('Locked','success'); fetchVaultStatus(); }).catch(() => showToast('Failed','error'));
}

function fetchRoutingConfig() {
  fetch('/admin/v1/routing-config').then(r=>r.json()).then(cfg => {
    if (cfg.default_mode) document.getElementById('route-mode').value = cfg.default_mode;
    if (cfg.default_max_budget_usd !== undefined) document.getElementById('route-budget').value = cfg.default_max_budget_usd;
    if (cfg.default_max_latency_ms !== undefined) document.getElementById('route-latency').value = cfg.default_max_latency_ms;
  }).catch(() => {});
}
function saveRoutingConfig() {
  fetch('/admin/v1/routing-config', { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
    default_mode: document.getElementById('route-mode').value,
    default_max_budget_usd: parseFloat(document.getElementById('route-budget').value)||0,
    default_max_latency_ms: parseInt(document.getElementById('route-latency').value)||0
  })}).then(r => { if (!r.ok) throw 0; showToast('Saved','success'); }).catch(() => showToast('Failed','error'));
}

function fetchHealthStatus() {
  fetch('/admin/v1/health').then(r=>r.json()).then(data => {
    const tbody = document.getElementById('health-body');
    const providers = data.providers || [];
    if (providers.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="color:#8a8d9a;text-align:center">No data</td></tr>'; return; }
    tbody.innerHTML = providers.map(p => {
      const er = p.total_requests > 0 ? (p.total_errors/p.total_requests*100).toFixed(1) : '0.0';
      const st = (p.state||'healthy').toLowerCase();
      const av = st==='healthy'?'yes':(st==='degraded'?'degraded':'no');
      return `<tr class="health-row ${st==='healthy'?'healthy':st==='degraded'?'degraded':'unavailable'}"><td>${p.provider_id}</td><td><span class="health-avail ${av}">${av}</span></td><td>${Math.round(p.avg_latency_ms||0)}ms</td><td>${er}%</td><td>${p.consec_errors||0}</td><td><span class="badge ${st==='healthy'?'healthy':st==='degraded'?'degraded':'down'}">${st}</span></td></tr>`;
    }).join('');
    // Ensure all providers are on the graph.
    providers.forEach(p => ensureNode(p.provider_id, p.provider_id, 'provider'));
  }).catch(() => {});
}

function classifyAction(a) {
  if (/create|upsert|update|add|register/i.test(a)) return 'create-update';
  if (/delete|remove|revoke/i.test(a)) return 'delete';
  if (/vault|secret|key|encrypt/i.test(a)) return 'vault';
  return 'other';
}
function fetchAuditLog() {
  fetch('/admin/v1/audit?limit=50').then(r=>r.json()).then(data => {
    document.getElementById('audit-body').innerHTML = (data.logs||[]).map(e =>
      `<tr><td>${new Date(e.timestamp).toLocaleTimeString()}</td><td><span class="audit-action ${classifyAction(e.action)}">${e.action}</span></td><td>${e.resource||'-'}</td><td>${e.request_id||'-'}</td></tr>`
    ).join('');
  }).catch(() => {});
}

let requestLogOffset = 0;
function fetchRequestLogs() {
  fetch(`/admin/v1/logs?limit=50&offset=${requestLogOffset}`).then(r=>r.json()).then(data => {
    const logs = data.logs || [];
    const tbody = document.getElementById('request-log-body');
    tbody.innerHTML = logs.length === 0 && requestLogOffset === 0
      ? '<tr><td colspan="9" style="color:#8a8d9a;text-align:center">No logs</td></tr>'
      : logs.map(e => {
        const latCls = e.latency_ms < 1000 ? 'color:#4caf50' : e.latency_ms <= 5000 ? 'color:#ffc107' : 'color:#f44336';
        const stCls = e.status_code === 200 ? 'color:#4caf50' : 'color:#f44336';
        const tok = e.total_tokens > 0 ? e.total_tokens.toLocaleString() : '-';
        return `<tr><td>${new Date(e.timestamp).toLocaleTimeString()}</td><td>${e.model_id||'-'}</td><td>${e.provider_id||'-'}</td><td>${e.mode||'-'}</td><td style="${latCls}">${e.latency_ms}</td><td>${tok}</td><td>$${(e.estimated_cost_usd||0).toFixed(6)}</td><td style="${stCls}">${e.status_code}</td><td>${e.request_id||'-'}</td></tr>`;
      }).join('');
    document.getElementById('req-log-page-info').textContent = `Page ${Math.floor(requestLogOffset/50)+1}`;
    document.getElementById('req-log-prev').disabled = requestLogOffset === 0;
    document.getElementById('req-log-next').disabled = logs.length < 50;
  }).catch(() => {});
}
function requestLogPrev() { requestLogOffset = Math.max(0, requestLogOffset - 50); fetchRequestLogs(); }
function requestLogNext() { requestLogOffset += 50; fetchRequestLogs(); }

function fetchAPIKeys() {
  fetch('/admin/v1/apikeys').then(r=>r.json()).then(data => {
    const keys = data.keys || [];
    document.getElementById('apikeys-body').innerHTML = keys.length === 0
      ? '<tr><td colspan="8" style="color:#8a8d9a;text-align:center">No keys</td></tr>'
      : keys.map(k => {
        const budget = k.monthly_budget_usd > 0 ? '$'+k.monthly_budget_usd.toFixed(2) : 'unlimited';
        return `<tr><td>${k.name}</td><td style="font-family:monospace;font-size:12px">${k.key_prefix}...</td><td>${k.scopes||'[]'}</td><td>${k.created_at?new Date(k.created_at).toLocaleDateString():'-'}</td><td>${k.last_used_at?new Date(k.last_used_at).toLocaleString():'never'}</td><td>${budget}</td><td style="color:${k.enabled?'#4caf50':'#f44336'}">${k.enabled?'yes':'no'}</td><td><button class="btn sm" onclick="rotateKey('${k.id}')">Rotate</button> <button class="btn sm" onclick="toggleKey('${k.id}',${!k.enabled})">${k.enabled?'Disable':'Enable'}</button> <button class="btn danger sm" onclick="revokeKey('${k.id}')">Revoke</button></td></tr>`;
      }).join('');
  }).catch(() => {});
}
function createAPIKey() {
  const name = document.getElementById('new-key-name').value.trim();
  if (!name) { showToast('Name required','error'); return; }
  const scopes = [];
  if (document.getElementById('scope-chat').checked) scopes.push('chat');
  if (document.getElementById('scope-plan').checked) scopes.push('plan');
  fetch('/admin/v1/apikeys', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
    name, scopes: JSON.stringify(scopes),
    rotation_days: parseInt(document.getElementById('new-key-rotation').value)||0,
    monthly_budget_usd: parseFloat(document.getElementById('new-key-budget').value)||0,
    ...(document.getElementById('new-key-expiry').value ? { expires_at: new Date(document.getElementById('new-key-expiry').value).toISOString() } : {})
  })}).then(r => { if (!r.ok) throw 0; return r.json(); })
    .then(d => { hideModal('create-key-modal'); document.getElementById('displayed-key').textContent = d.key; showModal('key-display-modal'); fetchAPIKeys(); })
    .catch(() => showToast('Failed','error'));
}
function rotateKey(id) {
  if (!confirm('Rotate this key?')) return;
  fetch('/admin/v1/apikeys/'+encodeURIComponent(id)+'/rotate', { method:'POST' })
    .then(r => { if (!r.ok) throw 0; return r.json(); })
    .then(d => { document.getElementById('displayed-key').textContent = d.key; showModal('key-display-modal'); fetchAPIKeys(); })
    .catch(() => showToast('Failed','error'));
}
function toggleKey(id, enabled) {
  fetch('/admin/v1/apikeys/'+encodeURIComponent(id), { method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({enabled}) })
    .then(r => { if (!r.ok) throw 0; showToast(enabled?'Enabled':'Disabled','success'); fetchAPIKeys(); })
    .catch(() => showToast('Failed','error'));
}
function revokeKey(id) {
  if (!confirm('Revoke this key permanently?')) return;
  fetch('/admin/v1/apikeys/'+encodeURIComponent(id), { method:'DELETE' })
    .then(r => { if (!r.ok) throw 0; showToast('Revoked','success'); fetchAPIKeys(); })
    .catch(() => showToast('Failed','error'));
}

function fetchWorkflows() {
  const status = document.getElementById('wf-status-filter').value;
  const qs = status ? `?status=${status}&limit=50` : '?limit=50';
  fetch('/admin/v1/workflows' + qs).then(r => r.status===503?{workflows:[],disabled:true}:r.json()).then(data => {
    const tbody = document.getElementById('workflows-body');
    if (data.disabled) { tbody.innerHTML = '<tr><td colspan="6" style="color:#8a8d9a;text-align:center">Temporal not enabled</td></tr>'; return; }
    const wfs = data.workflows || [];
    tbody.innerHTML = wfs.length === 0
      ? '<tr><td colspan="6" style="color:#8a8d9a;text-align:center">No workflows</td></tr>'
      : wfs.map(w => `<tr><td style="font-family:monospace;font-size:12px">${w.workflow_id||'-'}</td><td>${w.workflow_type||'-'}</td><td><span class="wf-badge ${(w.status||'').toLowerCase().replace(/_/g,'-')}">${w.status||'-'}</span></td><td>${w.start_time?new Date(w.start_time).toLocaleString():'-'}</td><td>${w.duration_ms?w.duration_ms+'ms':'-'}</td><td>${w.model_id||'-'}</td></tr>`).join('');
  }).catch(() => {});
}

// ============================
// Utilities
// ============================
function showModal(id) { document.getElementById(id).classList.add('visible'); }
function hideModal(id) { document.getElementById(id).classList.remove('visible'); }
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type + ' visible';
  setTimeout(() => { t.className = 'toast'; }, 3000);
}

// ============================
// Init
// ============================
document.addEventListener('DOMContentLoaded', () => {
  initChart();
  seedStatsFromServer();
  connectSSE();
  updateLeaderboard(); fetchAuditLog(); fetchVaultStatus(); fetchProviders();
  fetchModels(); fetchRoutingConfig(); fetchHealthStatus(); fetchRequestLogs();
  fetchAPIKeys(); fetchWorkflows(); fetchTrend('cost');
  setInterval(fetchRequestLogs, 15000);
  setInterval(fetchAuditLog, 10000);
  setInterval(fetchProviders, 30000);
  setInterval(fetchModels, 30000);
  setInterval(fetchHealthStatus, 10000);
  setInterval(fetchVaultStatus, 15000);
  setInterval(fetchAPIKeys, 15000);
  setInterval(fetchWorkflows, 5000);
  setInterval(updateLeaderboard, 15000);
});
</script>
</body>
</html>
