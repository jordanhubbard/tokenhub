# End-to-end test stack: Temporal + TokenHub + mock provider.
# Used by tests/e2e-temporal.sh.

services:
  temporal:
    image: temporalio/temporal:latest
    command:
      - server
      - start-dev
      - --ip
      - "0.0.0.0"
      - --log-format
      - json
    healthcheck:
      test: ["CMD", "temporal", "workflow", "list", "--address", "localhost:7233"]
      interval: 5s
      timeout: 5s
      start_period: 15s
      retries: 20

  mock-provider:
    image: nginx:alpine
    volumes:
      - ./mock-provider.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/"]
      interval: 5s
      timeout: 3s
      start_period: 5s
      retries: 10

  tokenhub:
    image: ${TOKENHUB_IMAGE:-tokenhub:e2e}
    ports:
      - "${E2E_PORT:-18081}:8080"
    environment:
      - TOKENHUB_LISTEN_ADDR=:8080
      - TOKENHUB_DB_DSN=file:/tmp/tokenhub-e2e.sqlite
      - TOKENHUB_VAULT_ENABLED=false
      - TOKENHUB_ADMIN_TOKEN=e2e-test-token
      - TOKENHUB_TEMPORAL_ENABLED=true
      - TOKENHUB_TEMPORAL_HOST=temporal:7233
      - TOKENHUB_TEMPORAL_NAMESPACE=default
      - TOKENHUB_TEMPORAL_TASK_QUEUE=tokenhub-e2e
    depends_on:
      temporal:
        condition: service_healthy
      mock-provider:
        condition: service_healthy
